<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Station Simulation Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      text-align: center;
    }

    select, button {
      margin: 5px;
      padding: 5px 10px;
      font-size: 16px;
    }

    #velocityImage {
      margin-top: 60px;
      margin-bottom: 30px;
      max-width: 100%;
      border: 1px solid #ccc;
      height: 450px;
      object-fit: contain;
      transform: scale(1.2);
      transform-origin: center center;
    }

    model-viewer {
      display: block;
      margin: 20px auto;
      width: 800px;
      height: 400px;
      background-color: #eee;
      border: 1px solid #ccc;
    }

    canvas {
      max-width: 800px;
      margin: 30px auto;
    }

    #costDisplay {
      margin-top: 10px;
      font-weight: bold;
      color: #333;
    }

    #videoContainer {
      max-width: 800px;
      margin: 0 auto 20px;
    }

    #legend {
      max-width: 800px;
      margin: 10px auto 30px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
    }

    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      border: 1px solid #333;
    }

    #loadingOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      color: white;
      font-size: 24px;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none;
    }

    /* Small visual polish for status */
    #phaseTitle {
      font-weight: bold;
    }
    #phaseDetail {
      opacity: 0.9;
    }
  </style>
</head>
<body>

  <h2>Station Simulation Viewer</h2>

  <!-- Embedded Video -->
  <div id="videoContainer">
    <video width="800" height="450" controls>
      <source src="videos/your-video.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <!-- 3D Model Viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <model-viewer id="stationModel" src="models/1111.glb"
                alt="3D Station Schematic"
                auto-rotate
                camera-controls
                shadow-intensity="1">
  </model-viewer>

  <!-- Dropdowns -->
  <div>
    <label>DR1: <select id="DR1" onchange="updateCost()"></select></label>
    <label>DR2: <select id="DR2" onchange="updateCost()"></select></label>
    <label>CP1: <select id="CP1" onchange="updateCost()"></select></label>
    <label>CP2: <select id="CP2" onchange="updateCost()"></select></label>
    <br/>
    <button id="simulateBtn">Simulate</button>
  </div>

  <!-- Cost Display -->
  <div id="costDisplay">Estimated Cost: £0k</div>

  <!-- Velocity Image -->
  <div style="text-align: center;">
    <img id="velocityImage" src="images/welcome.png" alt="Velocity Image" />
  </div>

  <!-- Chart -->
  <canvas id="velocityChart" width="800" height="400"></canvas>

  <!-- Legend -->
  <div id="legend">
    <div class="legend-item"><div class="legend-color" style="background: rgb(0, 189, 25);"></div> ≤ 5 m/s </div>
    <div class="legend-item"><div class="legend-color" style="background: rgb(0, 160, 226);"></div> > 5 to ≤ 8 m/s</div>
    <div class="legend-item"><div class="legend-color" style="background: rgb(255, 211, 41);"></div> > 8 to ≤ 10 m/s</div>
    <div class="legend-item"><div class="legend-color" style="background: rgb(239, 123, 16);"></div> > 10 to ≤ 12 m/s</div>
    <div class="legend-item"><div class="legend-color" style="background: rgb(147, 100, 204);"></div> > 12 to ≤ 13.5 m/s</div>
    <div class="legend-item"><div class="legend-color" style="background: rgb(228, 35, 19);"></div> > 13.5 to ≤ 15 m/s</div>
    <div class="legend-item"><div class="legend-color" style="background: rgb(161, 165, 167);"></div> > 15 to ≤ 17 m/s</div>
    <div class="legend-item"><div class="legend-color" style="background: rgb(0, 0, 0);"></div> > 17 m/s</div>
  </div>

  <!-- Loading Overlay with Phased Status -->
  <div id="loadingOverlay">
    <div style="text-align: center; max-width: 500px;">
      <div id="phaseTitle" style="font-size: 28px; margin-bottom: 8px;">Preparing...</div>
      <div id="phaseDetail" style="font-size: 16px; margin-bottom: 12px;">Initializing</div>
      <div id="progressBarContainer" style="margin-top: 10px; width: 100%; height: 20px; background: #444; border-radius: 10px; overflow: hidden;">
        <div id="progressBar" style="width: 0%; height: 100%; background: #4caf50; transition: width 0.2s;"></div>
      </div>
      <div id="progressPercent" style="margin-top: 10px; font-weight: bold;">0%</div>
      <div id="subProgress" style="margin-top: 8px; font-size: 14px; opacity: 0.9;">&nbsp;</div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>

  <script>
    Chart.register(window['chartjs-plugin-annotation']);

    const configOptions = {
      DR1: [
        { label: "NONE", cost: 0 },
        { label: "Area = 3m2", cost: 50 },
        { label: "Area = 5m2", cost: 100 },
        { label: "Area = 7m2", cost: 150 },
        { label: "Area = 9m2", cost: 200 },
        { label: "Area = 12m2", cost: 250 }
      ],
      DR2: [
        { label: "NONE", cost: 0 },
        { label: "Area = 3m2", cost: 50 },
        { label: "Area = 5m2", cost: 100 },
        { label: "Area = 7m2", cost: 150 },
        { label: "Area = 9m2", cost: 200 },
        { label: "Area = 12m2", cost: 250 }
      ],
      CP1: [
        { label: "NONE", cost: 0 },
        { label: "Area = 3m2", cost: 20 },
        { label: "Area = 4m2", cost: 40 },
        { label: "Area = 5m2", cost: 60 },
        { label: "Area = 6m2", cost: 80 },
        { label: "Area = 7m2", cost: 100 }
      ],
      CP2: [
        { label: "NONE", cost: 0 },
        { label: "Area = 3m2", cost: 20 },
        { label: "Area = 4m2", cost: 40 },
        { label: "Area = 5m2", cost: 60 },
        { label: "Area = 6m2", cost: 80 },
        { label: "Area = 7m2", cost: 100 }
      ]
    };

    // cache DOM refs
    const selects = ['DR1', 'DR2', 'CP1', 'CP2'].reduce((acc, id) => {
      acc[id] = document.getElementById(id);
      return acc;
    }, {});
    const costDisplay = document.getElementById('costDisplay');
    const velocityImage = document.getElementById('velocityImage');
    const simulateBtn = document.getElementById('simulateBtn');

    for (const id in configOptions) {
      const select = selects[id];
      configOptions[id].forEach((opt, index) => {
        const option = document.createElement('option');
        option.value = index + 1;
        option.text = opt.label;
        select.appendChild(option);
      });
    }

    function getCode() {
      return ['DR1', 'DR2', 'CP1', 'CP2']
        .map(id => selects[id].value)
        .join('');
    }

    function calculateCost() {
      let cost = 0;
      for (const id in configOptions) {
        const selectedIndex = parseInt(selects[id].value, 10) - 1;
        cost += configOptions[id][selectedIndex].cost;
      }
      return cost;
    }

    function updateCost() {
      costDisplay.innerText = `Estimated Cost: £${calculateCost()}k`;
    }

    function updateModel() {
      const code = getCode();
      const modelViewer = document.getElementById('stationModel');
      modelViewer.src = `models/${code}.glb`;
    }

    let chart;

    function drawChart(labels, data) {
      const ctx = document.getElementById('velocityChart').getContext('2d');
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Velocity (m/s)',
            data,
            backgroundColor: data.map(v => {
              const absV = Math.abs(v);
              if (absV <= 5) return 'rgb(0, 189, 25)';
              if (absV <= 8) return 'rgb(0, 160, 226)';
              if (absV <= 10) return 'rgb(255, 211, 41)';
              if (absV <= 12) return 'rgb(239, 123, 16)';
              if (absV <= 13.5) return 'rgb(147, 100, 204)';
              if (absV <= 15) return 'rgb(228, 35, 19)';
              if (absV <= 17) return 'rgb(161, 165, 167)';
              return 'rgb(0, 0, 0)';
            }),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Velocity (m/s)'
              },
              suggestedMax: Math.max(...data, 12) + 1
            }
          },
          plugins: {
            legend: { display: false },
            annotation: {
              annotations: {
                limit8: {
                  type: 'line',
                  yMin: 8,
                  yMax: 8,
                  borderColor: 'rgb(255, 215, 0)',
                  borderWidth: 2,
                  label: {
                    enabled: true,
                    content: 'Limit 8 m/s',
                    backgroundColor: 'rgb(255, 215, 0)',
                    color: 'black'
                  }
                },
                limit10: {
                  type: 'line',
                  yMin: 10,
                  yMax: 10,
                  borderColor: 'rgb(255, 0, 0)',
                  borderWidth: 2,
                  label: {
                    enabled: true,
                    content: 'Limit 10 m/s',
                    backgroundColor: 'rgb(255, 0, 0)',
                    color: 'white'
                  }
                }
              }
            }
          }
        }
      });
    }

async function simulate() {
  const overlay = document.getElementById('loadingOverlay');
  const progressBar = document.getElementById('progressBar');
  const progressPercent = document.getElementById('progressPercent');
  const phaseTitle = document.getElementById('phaseTitle');
  const phaseDetail = document.getElementById('phaseDetail');
  const subProgress = document.getElementById('subProgress');

  simulateBtn.disabled = true;
  overlay.style.display = 'flex';
  progressBar.style.width = '0%';
  progressPercent.innerText = '0%';
  subProgress.innerText = '';

  const code = getCode();

  // Phases with weights (sum=1) and durations scaled so total = 20000ms
  const phases = [
    { title: 'Initialising Simulation', detail: 'Setting up environment', weight: 0.1, duration: 3000 },
    { title: 'Reading openSES input file', detail: `Loading configuration ${code}`, weight: 0.1, duration: 3500 },
    { title: 'Simulating', detail: 'Running air velocity preset', weight: 0.6, duration: 15000 },
    { title: 'Post-processing Results', detail: 'Aggregating output', weight: 0.2, duration: 6000 }
  ];

  let accumulated = 0;

  function setGlobalProgress(fraction) {
    const pct = Math.min(Math.round(fraction * 100), 100);
    progressBar.style.width = `${(fraction * 100).toFixed(2)}%`;

    progressPercent.innerText = `${Math.min(Math.round(fraction * 100), 100)}%`;

  }

  // Utility to animate a phase with smooth progress; optional per-phase callback for extra UI (like subProgress)
  function runPhase(phase) {
    return new Promise(resolve => {
      const start = performance.now();
      let dotCounter = 0;
      let lastDotUpdate = start;

      function step(now) {
        const elapsed = now - start;
        const localFrac = Math.min(elapsed / phase.duration, 1);
        setGlobalProgress(accumulated + localFrac * phase.weight);

        // Update detail text with dots for non-simulating phases
        if (phase.title !== 'Simulating') {
          if (now - lastDotUpdate >= 400) {
            dotCounter = (dotCounter + 1) % 4;
            phaseDetail.innerText = `${phase.detail} ${'.'.repeat(dotCounter)}`;
            lastDotUpdate = now;
          }
        } else {
          // Simulating shows its own subprogress
          subProgress.innerText = `Simulation progress: ${Math.round(localFrac * 100)}%`;
        }

        if (elapsed < phase.duration) {
          requestAnimationFrame(step);
        } else {
          // End-of-phase cleanup
          if (phase.title === 'Simulating') {
            subProgress.innerText = '';
          } else {
            phaseDetail.innerText = phase.detail; // remove dots
          }
          setGlobalProgress(accumulated + phase.weight); // ensure it snaps exactly to end of phase
          resolve();
        }
      }

      // Set titles/details immediately and begin animation
      phaseTitle.innerText = phase.title;
      phaseDetail.innerText = phase.detail;
      requestAnimationFrame(step);
    });
  }

  for (const phase of phases) {
    await runPhase(phase);
    accumulated += phase.weight;
  }

  // Post-phase: update model, image, chart
  updateModel();
  velocityImage.src = `images/${code}.png`;

  try {
    const response = await fetch('data.csv');
    if (!response.ok) throw new Error("Failed to load data.csv");
    const text = await response.text();
    const rows = text.trim().split('\n').slice(1);

    const sections = [];
    const velocities = [];

    rows.forEach(row => {
      const [time, section, velocity] = row.split(',');
      if (time === code) {
        sections.push(section);
        velocities.push(parseFloat(velocity));
      }
    });

    if (velocities.length === 0) {
      alert(`No velocity data found for configuration ${code}`);
    } else {
      drawChart(sections, velocities);
    }
  } catch (err) {
    alert("Simulation error: " + err.message);
  }

  phaseTitle.innerText = 'Complete';
  phaseDetail.innerText = `Configuration ${code} processed`;
  setGlobalProgress(1);
  subProgress.innerText = '';
  setTimeout(() => {
    overlay.style.display = 'none';
    simulateBtn.disabled = false;
  }, 1500);
}

    // Wire up
    window.addEventListener('DOMContentLoaded', () => {
      ['DR1', 'DR2', 'CP1', 'CP2'].forEach(id => {
        selects[id].value = '1';
      });
      updateCost();
      simulateBtn.addEventListener('click', simulate);
    });
  </script>

</body>
</html>

